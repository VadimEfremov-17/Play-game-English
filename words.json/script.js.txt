// –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã
let gameState = {
    currentLevel: null,
    currentMode: null,
    currentQuestion: 0,
    score: 0,
    correctAnswers: 0,
    totalQuestions: 10,
    timeLeft: 0,
    timerInterval: null,
    currentWord: null,
    questions: [],
    gameActive: false,
    startTime: null
};

let appState = {
    words: {},
    stats: {
        gamesPlayed: 0,
        bestScore: 0,
        wordsLearned: new Set(),
        totalAnswers: 0,
        correctAnswers: 0
    },
    settings: {
        soundEnabled: true,
        questionsCount: 10,
        timerSeconds: 15,
        theme: 'light'
    }
};

// DOM —ç–ª–µ–º–µ–Ω—Ç—ã
const sections = {
    main: document.getElementById('main-menu'),
    level: document.getElementById('level-select'),
    mode: document.getElementById('mode-select'),
    game: document.getElementById('game-screen'),
    results: document.getElementById('results-screen'),
    dictionary: document.getElementById('dictionary-screen'),
    addWord: document.getElementById('add-word-screen'),
    stats: document.getElementById('stats-screen'),
    settings: document.getElementById('settings-screen')
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadGameData();
    updateUIStats();
    showSection('main');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–ª–æ–≤–∞, –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö
    if (Object.keys(appState.words).length === 0) {
        loadDefaultWords();
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    applySettings();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
    initEventListeners();
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä—ã
function loadGameData() {
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤
    const savedWords = localStorage.getItem('wordMasterWords');
    if (savedWords) {
        appState.words = JSON.parse(savedWords);
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    const savedStats = localStorage.getItem('wordMasterStats');
    if (savedStats) {
        const stats = JSON.parse(savedStats);
        appState.stats = {
            ...stats,
            wordsLearned: new Set(stats.wordsLearned || [])
        };
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    const savedSettings = localStorage.getItem('wordMasterSettings');
    if (savedSettings) {
        appState.settings = JSON.parse(savedSettings);
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä—ã
function saveGameData() {
    localStorage.setItem('wordMasterWords', JSON.stringify(appState.words));
    localStorage.setItem('wordMasterStats', JSON.stringify({
        ...appState.stats,
        wordsLearned: Array.from(appState.stats.wordsLearned)
    }));
    localStorage.setItem('wordMasterSettings', JSON.stringify(appState.settings));
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Å–ª–æ–≤
function loadDefaultWords() {
    appState.words = {
        beginner: [
            {
                en: "apple",
                ru: "—è–±–ª–æ–∫–æ",
                example: "I eat an apple every day for breakfast."
            },
            {
                en: "house",
                ru: "–¥–æ–º",
                example: "They live in a big house near the park."
            },
            {
                en: "book",
                ru: "–∫–Ω–∏–≥–∞",
                example: "This book is very interesting and educational."
            },
            {
                en: "water",
                ru: "–≤–æ–¥–∞",
                example: "Drink more water to stay healthy."
            },
            {
                en: "friend",
                ru: "–¥—Ä—É–≥",
                example: "He is my best friend since childhood."
            },
            {
                en: "school",
                ru: "—à–∫–æ–ª–∞",
                example: "My children go to school by bus every morning."
            },
            {
                en: "computer",
                ru: "–∫–æ–º–ø—å—é—Ç–µ—Ä",
                example: "I use my computer for work and entertainment."
            },
            {
                en: "time",
                ru: "–≤—Ä–µ–º—è",
                example: "What time is it? I need to leave soon."
            },
            {
                en: "city",
                ru: "–≥–æ—Ä–æ–¥",
                example: "New York is a big city with many opportunities."
            },
            {
                en: "music",
                ru: "–º—É–∑—ã–∫–∞",
                example: "I listen to music while working to concentrate better."
            }
        ],
        intermediate: [
            {
                en: "achieve",
                ru: "–¥–æ—Å—Ç–∏–≥–∞—Ç—å",
                example: "With hard work, you can achieve your goals."
            },
            {
                en: "knowledge",
                ru: "–∑–Ω–∞–Ω–∏–µ",
                example: "Knowledge is power when used wisely."
            },
            {
                en: "experience",
                ru: "–æ–ø—ã—Ç",
                example: "This job requires at least 3 years of experience."
            },
            {
                en: "environment",
                ru: "–æ–∫—Ä—É–∂–∞—é—â–∞—è —Å—Ä–µ–¥–∞",
                example: "We should protect the environment for future generations."
            },
            {
                en: "opportunity",
                ru: "–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å",
                example: "This is a great opportunity to learn something new."
            }
        ],
        advanced: [
            {
                en: "perseverance",
                ru: "–Ω–∞—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å",
                example: "Success requires perseverance and determination."
            },
            {
                en: "sophisticated",
                ru: "–∏—Å–∫—É—à–µ–Ω–Ω—ã–π, —Å–ª–æ–∂–Ω—ã–π",
                example: "This is a sophisticated piece of technology."
            },
            {
                en: "ambiguity",
                ru: "–¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç—å",
                example: "The contract's ambiguity led to misunderstandings."
            }
        ]
    };
    
    saveGameData();
    updateWordCounts();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ UI
function updateUIStats() {
    // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤
    let totalWords = 0;
    for (const level in appState.words) {
        totalWords += appState.words[level].length;
    }
    document.getElementById('total-words').textContent = totalWords;
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    document.getElementById('games-played').textContent = appState.stats.gamesPlayed;
    document.getElementById('best-score').textContent = appState.stats.bestScore;
    
    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤ –ø–æ —É—Ä–æ–≤–Ω—è–º
    document.getElementById('count-beginner').textContent = 
        `${appState.words.beginner ? appState.words.beginner.length : 0} —Å–ª–æ–≤`;
    document.getElementById('count-intermediate').textContent = 
        `${appState.words.intermediate ? appState.words.intermediate.length : 0} —Å–ª–æ–≤`;
    document.getElementById('count-advanced').textContent = 
        `${appState.words.advanced ? appState.words.advanced.length : 0} —Å–ª–æ–≤`;
}

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å–µ–∫—Ü–∏–∏
function showSection(sectionName) {
    // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏
    Object.values(sections).forEach(section => {
        section.classList.remove('active');
    });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é
    if (sections[sectionName]) {
        sections[sectionName].classList.add('active');
    }
    
    // –û—Å–æ–±—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–µ–∫—Ü–∏–π
    if (sectionName === 'dictionary') {
        displayDictionary();
    } else if (sectionName === 'stats') {
        displayStats();
    } else if (sectionName === 'settings') {
        loadSettingsToUI();
    }
}

// –ù–∞–≤–∏–≥–∞—Ü–∏—è
function showMainMenu() {
    showSection('main');
    updateUIStats();
}

function startGame() {
    showSection('level');
}

function showLevelSelect() {
    showSection('level');
}

function showModeSelect() {
    showSection('mode');
}

function showDictionary() {
    showSection('dictionary');
}

function showAddWord() {
    showSection('addWord');
}

function showStats() {
    showSection('stats');
}

function showSettings() {
    showSection('settings');
}

// –í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è
function selectLevel(level) {
    gameState.currentLevel = level;
    showSection('mode');
}

// –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞
function selectMode(mode) {
    gameState.currentMode = mode;
    startNewGame();
}

// –ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–π –∏–≥—Ä—ã
function startNewGame() {
    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
    gameState.currentQuestion = 0;
    gameState.score = 0;
    gameState.correctAnswers = 0;
    gameState.questions = [];
    gameState.gameActive = true;
    gameState.startTime = Date.now();
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    gameState.totalQuestions = appState.settings.questionsCount;
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤
    generateQuestions();
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    document.getElementById('current-level-badge').textContent = 
        gameState.currentLevel === 'beginner' ? '–ù–∞—á–∏–Ω–∞—é—â–∏–π' : 
        gameState.currentLevel === 'intermediate' ? '–°—Ä–µ–¥–Ω–∏–π' : '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π';
    
    document.getElementById('current-mode-badge').textContent = 
        getModeName(gameState.currentMode);
    
    document.getElementById('current-score').textContent = '0';
    document.getElementById('question-counter').textContent = `1/${gameState.totalQuestions}`;
    document.getElementById('progress-fill').style.width = '0%';
    
    // –ü–æ–∫–∞–∑ –∏–≥—Ä–æ–≤–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
    showSection('game');
    
    // –ó–∞–ø—É—Å–∫ –ø–µ—Ä–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    showNextQuestion();
    
    // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω
    if (appState.settings.timerSeconds > 0) {
        startTimer();
    }
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤
function generateQuestions() {
    const words = appState.words[gameState.currentLevel];
    if (!words || words.length === 0) {
        showNotification('–í —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ –Ω–µ—Ç —Å–ª–æ–≤! –î–æ–±–∞–≤—å—Ç–µ —Å–ª–æ–≤–∞ —Å–Ω–∞—á–∞–ª–∞.', 'error');
        showMainMenu();
        return;
    }
    
    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Å–ª–æ–≤–∞
    const selectedWords = [];
    const availableWords = [...words];
    
    for (let i = 0; i < gameState.totalQuestions && availableWords.length > 0; i++) {
        const randomIndex = Math.floor(Math.random() * availableWords.length);
        selectedWords.push(availableWords[randomIndex]);
        availableWords.splice(randomIndex, 1);
    }
    
    gameState.questions = selectedWords;
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
function showNextQuestion() {
    if (gameState.currentQuestion >= gameState.totalQuestions) {
        endGame();
        return;
    }
    
    gameState.currentWord = gameState.questions[gameState.currentQuestion];
    gameState.currentQuestion++;
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞
    document.getElementById('question-counter').textContent = 
        `${gameState.currentQuestion}/${gameState.totalQuestions}`;
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    const progress = ((gameState.currentQuestion - 1) / gameState.totalQuestions) * 100;
    document.getElementById('progress-fill').style.width = `${progress}%`;
    
    // –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    document.getElementById('question-container').innerHTML = '';
    document.getElementById('answer-container').innerHTML = '';
    document.getElementById('result-feedback').innerHTML = '';
    document.getElementById('result-feedback').className = 'feedback';
    
    // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞
    if (appState.settings.timerSeconds > 0) {
        resetTimer();
    }
    
    // –ü–æ–∫–∞–∑ –≤–æ–ø—Ä–æ—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
    switch (gameState.currentMode) {
        case 'translation-ru-en':
            showTranslationQuestion('ru', 'en');
            break;
        case 'translation-en-ru':
            showTranslationQuestion('en', 'ru');
            break;
        case 'multiple-choice':
            showMultipleChoiceQuestion();
            break;
        case 'fill-blank':
            showFillBlankQuestion();
            break;
        case 'dictation':
            showDictationQuestion();
            break;
        case 'mixed':
            showMixedQuestion();
            break;
    }
}

// –í–æ–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥
function showTranslationQuestion(fromLang, toLang) {
    const questionContainer = document.getElementById('question-container');
    const answerContainer = document.getElementById('answer-container');
    
    // –ü–æ–∫–∞–∑ –≤–æ–ø—Ä–æ—Å–∞
    const questionText = gameState.currentWord[fromLang];
    questionContainer.innerHTML = `
        <div class="question-text">–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ: <strong>${questionText}</strong></div>
    `;
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞
    answerContainer.innerHTML = `
        <input type="text" class="input-answer" id="user-answer" 
               placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥..." autocomplete="off">
    `;
    
    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    document.getElementById('user-answer').focus();
}

// –í–æ–ø—Ä–æ—Å —Å –≤—ã–±–æ—Ä–æ–º –æ—Ç–≤–µ—Ç–∞
function showMultipleChoiceQuestion() {
    const questionContainer = document.getElementById('question-container');
    const answerContainer = document.getElementById('answer-container');
    
    // –ü–æ–∫–∞–∑ –≤–æ–ø—Ä–æ—Å–∞
    questionContainer.innerHTML = `
        <div class="question-text">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ —Å–ª–æ–≤–∞: <strong>${gameState.currentWord.en}</strong></div>
    `;
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
    const words = appState.words[gameState.currentLevel];
    const wrongWords = [];
    
    // –í—ã–±–∏—Ä–∞–µ–º 3 —Å–ª—É—á–∞–π–Ω—ã—Ö –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞
    const availableWords = words.filter(w => w.en !== gameState.currentWord.en);
    for (let i = 0; i < 3 && availableWords.length > 0; i++) {
        const randomIndex = Math.floor(Math.random() * availableWords.length);
        wrongWords.push(availableWords[randomIndex]);
        availableWords.splice(randomIndex, 1);
    }
    
    // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º
    const allOptions = [...wrongWords, gameState.currentWord];
    shuffleArray(allOptions);
    
    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    const correctIndex = allOptions.indexOf(gameState.currentWord);
    
    // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
    let optionsHTML = '<div class="answer-options">';
    allOptions.forEach((word, index) => {
        optionsHTML += `
            <div class="answer-option" data-index="${index}" onclick="selectAnswer(this, ${index === correctIndex})">
                ${word.ru}
            </div>
        `;
    });
    optionsHTML += '</div>';
    
    answerContainer.innerHTML = optionsHTML;
}

// –í–æ–ø—Ä–æ—Å —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø—É—Å–∫–∞
function showFillBlankQuestion() {
    const questionContainer = document.getElementById('question-container');
    const answerContainer = document.getElementById('answer-container');
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –ø—Ä–æ–ø—É—Å–∫–æ–º
    const sentence = gameState.currentWord.example;
    const targetWord = gameState.currentWord.en;
    const sentenceWithGap = sentence.replace(new RegExp(targetWord, 'gi'), '__________');
    
    // –ü–æ–∫–∞–∑ –≤–æ–ø—Ä–æ—Å–∞
    questionContainer.innerHTML = `
        <div class="question-text">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–ø—É—Å–∫ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏:</div>
        <div class="question-example">"${sentenceWithGap}"</div>
        <div class="hint-text">–ü–µ—Ä–µ–≤–æ–¥ –ø—Ä–æ–ø—É—â–µ–Ω–Ω–æ–≥–æ —Å–ª–æ–≤–∞: ${gameState.currentWord.ru}</div>
    `;
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞
    answerContainer.innerHTML = `
        <input type="text" class="input-answer" id="user-answer" 
               placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ..." autocomplete="off">
    `;
    
    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    document.getElementById('user-answer').focus();
}

// –î–∏–∫—Ç–∞–Ω—Ç
function showDictationQuestion() {
    const questionContainer = document.getElementById('question-container');
    const answerContainer = document.getElementById('answer-container');
    
    // –ü–æ–∫–∞–∑ –≤–æ–ø—Ä–æ—Å–∞
    questionContainer.innerHTML = `
        <div class="question-text">–ù–∞–ø–∏—à–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º:</div>
        <div class="question-text"><strong>${gameState.currentWord.ru}</strong></div>
    `;
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞
    answerContainer.innerHTML = `
        <input type="text" class="input-answer" id="user-answer" 
               placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º..." autocomplete="off">
    `;
    
    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    document.getElementById('user-answer').focus();
}

// –°–º–µ—à–∞–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å
function showMixedQuestion() {
    // –°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞
    const questionTypes = ['translation-ru-en', 'translation-en-ru', 'multiple-choice', 'fill-blank', 'dictation'];
    const randomType = questionTypes[Math.floor(Math.random() * questionTypes.length)];
    
    // –í—Ä–µ–º–µ–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    const originalMode = gameState.currentMode;
    gameState.currentMode = randomType;
    
    switch (randomType) {
        case 'translation-ru-en':
            showTranslationQuestion('ru', 'en');
            break;
        case 'translation-en-ru':
            showTranslationQuestion('en', 'ru');
            break;
        case 'multiple-choice':
            showMultipleChoiceQuestion();
            break;
        case 'fill-blank':
            showFillBlankQuestion();
            break;
        case 'dictation':
            showDictationQuestion();
            break;
    }
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ä–µ–∂–∏–º
    gameState.currentMode = originalMode;
}

// –í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞ (–¥–ª—è multiple-choice)
function selectAnswer(element, isCorrect) {
    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
    document.querySelectorAll('.answer-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    element.classList.add('selected');
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
    gameState.selectedAnswer = {
        element: element,
        isCorrect: isCorrect
    };
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞
function checkAnswer() {
    let isCorrect = false;
    let userAnswer = '';
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
    switch (gameState.currentMode) {
        case 'translation-ru-en':
        case 'translation-en-ru':
        case 'fill-blank':
        case 'dictation':
            const input = document.getElementById('user-answer');
            if (!input || !input.value.trim()) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç!', 'warning');
                return;
            }
            userAnswer = input.value.trim().toLowerCase();
            const correctAnswer = getCorrectAnswer();
            isCorrect = checkAnswerEquality(userAnswer, correctAnswer);
            break;
            
        case 'multiple-choice':
            if (!gameState.selectedAnswer) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç!', 'warning');
                return;
            }
            isCorrect = gameState.selectedAnswer.isCorrect;
            break;
            
        case 'mixed':
            // –î–ª—è —Å–º–µ—à–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞
            const mixedInput = document.getElementById('user-answer');
            if (mixedInput) {
                userAnswer = mixedInput.value.trim().toLowerCase();
                const mixedCorrectAnswer = getCorrectAnswer();
                isCorrect = checkAnswerEquality(userAnswer, mixedCorrectAnswer);
            } else if (gameState.selectedAnswer) {
                isCorrect = gameState.selectedAnswer.isCorrect;
            } else {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç!', 'warning');
                return;
            }
            break;
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    processAnswerResult(isCorrect, userAnswer);
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
function getCorrectAnswer() {
    switch (gameState.currentMode) {
        case 'translation-ru-en':
            return gameState.currentWord.en.toLowerCase();
        case 'translation-en-ru':
        case 'multiple-choice':
            return gameState.currentWord.ru.toLowerCase();
        case 'fill-blank':
        case 'dictation':
            return gameState.currentWord.en.toLowerCase();
        case 'mixed':
            // –î–ª—è —Å–º–µ—à–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞ –ª–µ—Ç—É
            return gameState.currentWord.en.toLowerCase();
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–≤–µ–Ω—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤ (—Å —É—á–µ—Ç–æ–º –≤–æ–∑–º–æ–∂–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
function checkAnswerEquality(userAnswer, correctAnswer) {
    // –†–∞–∑–¥–µ–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–µ—Ä–µ–≤–æ–¥–∞ (–µ—Å–ª–∏ –∏—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
    const correctAnswers = correctAnswer.split(',').map(a => a.trim().toLowerCase());
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –æ–¥–Ω–∏–º –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
    return correctAnswers.includes(userAnswer);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞
function processAnswerResult(isCorrect, userAnswer = '') {
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    appState.stats.totalAnswers++;
    if (isCorrect) {
        appState.stats.correctAnswers++;
        gameState.correctAnswers++;
        
        // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤
        let points = 0;
        switch (gameState.currentMode) {
            case 'multiple-choice':
                points = 1;
                break;
            case 'translation-ru-en':
            case 'translation-en-ru':
            case 'fill-blank':
                points = 2;
                break;
            case 'dictation':
                points = 3;
                break;
            case 'mixed':
                points = 2; // –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                break;
        }
        
        gameState.score += points;
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ–≤–∞ –≤ –∏–∑—É—á–µ–Ω–Ω—ã–µ
        appState.stats.wordsLearned.add(gameState.currentWord.en);
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞
        document.getElementById('current-score').textContent = gameState.score;
        
        // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        showFeedback(isCorrect, userAnswer);
        
        // –ó–≤—É–∫–æ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç
        if (appState.settings.soundEnabled) {
            playSound('correct');
        }
        
        // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            gameState.selectedAnswer = null;
            showNextQuestion();
        }, 1500);
    } else {
        // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        showFeedback(isCorrect, userAnswer);
        
        // –ó–≤—É–∫–æ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç
        if (appState.settings.soundEnabled) {
            playSound('incorrect');
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç 2 —Å–µ–∫—É–Ω–¥—ã, –∑–∞—Ç–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
        setTimeout(() => {
            gameState.selectedAnswer = null;
            showNextQuestion();
        }, 2000);
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    saveGameData();
}

// –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
function showFeedback(isCorrect, userAnswer) {
    const feedbackContainer = document.getElementById('result-feedback');
    const correctAnswer = getCorrectAnswer();
    
    if (isCorrect) {
        feedbackContainer.className = 'feedback correct';
        feedbackContainer.innerHTML = `
            <div class="feedback-content">
                <h3><i class="fas fa-check-circle"></i> –ü—Ä–∞–≤–∏–ª—å–Ω–æ!</h3>
                <p>–í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ –æ—á–∫–∏!</p>
                <p><strong>${gameState.currentWord.en}</strong> - <strong>${gameState.currentWord.ru}</strong></p>
                <p class="question-example">–ü—Ä–∏–º–µ—Ä: ${gameState.currentWord.example}</p>
            </div>
        `;
    } else {
        feedbackContainer.className = 'feedback incorrect';
        feedbackContainer.innerHTML = `
            <div class="feedback-content">
                <h3><i class="fas fa-times-circle"></i> –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</h3>
                <p>–í–∞—à –æ—Ç–≤–µ—Ç: <strong>${userAnswer || '–Ω–µ –≤—ã–±—Ä–∞–Ω'}</strong></p>
                <p>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <strong>${correctAnswer}</strong></p>
                <p><strong>${gameState.currentWord.en}</strong> - <strong>${gameState.currentWord.ru}</strong></p>
                <p class="question-example">–ü—Ä–∏–º–µ—Ä: ${gameState.currentWord.example}</p>
            </div>
        `;
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
function showHint() {
    const feedbackContainer = document.getElementById('result-feedback');
    feedbackContainer.className = 'feedback hint';
    
    let hintText = '';
    switch (gameState.currentMode) {
        case 'translation-ru-en':
            hintText = `–ü–µ—Ä–≤–∞—è –±—É–∫–≤–∞: <strong>${gameState.currentWord.en[0].toUpperCase()}</strong>`;
            break;
        case 'translation-en-ru':
            hintText = `–ü–µ—Ä–≤–∞—è –±—É–∫–≤–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: <strong>${gameState.currentWord.ru[0].toUpperCase()}</strong>`;
            break;
        case 'fill-blank':
            hintText = `–î–ª–∏–Ω–∞ —Å–ª–æ–≤–∞: <strong>${gameState.currentWord.en.length}</strong> –±—É–∫–≤`;
            break;
        case 'dictation':
            hintText = `–ü–µ—Ä–≤–∞—è –±—É–∫–≤–∞: <strong>${gameState.currentWord.en[0].toUpperCase()}</strong>, –¥–ª–∏–Ω–∞: <strong>${gameState.currentWord.en.length}</strong> –±—É–∫–≤`;
            break;
        default:
            hintText = `–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!`;
    }
    
    feedbackContainer.innerHTML = `
        <div class="feedback-content">
            <h3><i class="fas fa-lightbulb"></i> –ü–æ–¥—Å–∫–∞–∑–∫–∞</h3>
            <p>${hintText}</p>
        </div>
    `;
    
    // –®—Ç—Ä–∞—Ñ –∑–∞ –ø–æ–¥—Å–∫–∞–∑–∫—É (–º–∏–Ω—É—Å 1 –æ—á–∫–æ)
    gameState.score = Math.max(0, gameState.score - 1);
    document.getElementById('current-score').textContent = gameState.score;
}

// –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤–æ–ø—Ä–æ—Å
function skipQuestion() {
    showFeedback(false, '–ø—Ä–æ–ø—É—â–µ–Ω–æ');
    
    // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
    setTimeout(() => {
        gameState.selectedAnswer = null;
        showNextQuestion();
    }, 1000);
}

// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã
function endGame() {
    gameState.gameActive = false;
    
    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞
    if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
    }
    
    // –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∏–≥—Ä—ã
    const endTime = Date.now();
    const gameTime = Math.floor((endTime - gameState.startTime) / 1000);
    const minutes = Math.floor(gameTime / 60);
    const seconds = gameTime % 60;
    const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    appState.stats.gamesPlayed++;
    if (gameState.score > appState.stats.bestScore) {
        appState.stats.bestScore = gameState.score;
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    saveGameData();
    
    // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    document.getElementById('final-score').textContent = gameState.score;
    document.getElementById('correct-answers').textContent = 
        `${gameState.correctAnswers}/${gameState.totalQuestions}`;
    document.getElementById('game-time').textContent = timeString;
    
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏
    const accuracy = (gameState.correctAnswers / gameState.totalQuestions) * 100;
    let rating = '';
    let ratingClass = '';
    
    if (accuracy >= 90) {
        rating = '–û—Ç–ª–∏—á–Ω–æ! üéâ';
        ratingClass = 'excellent';
    } else if (accuracy >= 70) {
        rating = '–•–æ—Ä–æ—à–æ! üëç';
        ratingClass = 'good';
    } else if (accuracy >= 50) {
        rating = '–ù–µ–ø–ª–æ—Ö–æ! üòä';
        ratingClass = 'average';
    } else {
        rating = '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ! üí™';
        ratingClass = 'poor';
    }
    
    document.getElementById('performance-rating').textContent = rating;
    document.getElementById('performance-rating').className = `rating ${ratingClass}`;
    
    // –ü–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    showSection('results');
}

// –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã
function restartGame() {
    startNewGame();
}

// –¢–∞–π–º–µ—Ä
function startTimer() {
    gameState.timeLeft = appState.settings.timerSeconds;
    updateTimerDisplay();
    
    gameState.timerInterval = setInterval(() => {
        gameState.timeLeft--;
        updateTimerDisplay();
        
        if (gameState.timeLeft <= 0) {
            clearInterval(gameState.timerInterval);
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ (–∏–ª–∏ –ø—Ä–æ–ø—É—Å–∫)
            if (gameState.currentMode === 'multiple-choice' && gameState.selectedAnswer) {
                checkAnswer();
            } else {
                skipQuestion();
            }
        }
    }, 1000);
}

function resetTimer() {
    if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
    }
    gameState.timeLeft = appState.settings.timerSeconds;
    updateTimerDisplay();
}

function updateTimerDisplay() {
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –≤ UI
    // –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç —Å id="timer" –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –µ–≥–æ
}

// –£—Ç–∏–ª–∏—Ç—ã
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function getModeName(mode) {
    const modeNames = {
        'translation-ru-en': '–†—É—Å ‚Üí –ê–Ω–≥–ª',
        'translation-en-ru': '–ê–Ω–≥–ª ‚Üí –†—É—Å',
        'multiple-choice': '–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞',
        'fill-blank': '–ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ–ø—É—Å–∫',
        'dictation': '–î–∏–∫—Ç–∞–Ω—Ç',
        'mixed': '–°–º–µ—à–∞–Ω–Ω—ã–π'
    };
    return modeNames[mode] || mode;
}

// –°–ª–æ–≤–∞—Ä—å
function displayDictionary() {
    const dictionaryList = document.getElementById('dictionary-list');
    const searchTerm = document.getElementById('word-search').value.toLowerCase();
    const levelFilter = document.getElementById('dictionary-level-filter').value;
    
    let allWords = [];
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–ª–æ–≤–∞ —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞
    for (const level in appState.words) {
        if (levelFilter === 'all' || levelFilter === level) {
            appState.words[level].forEach(word => {
                allWords.push({...word, level: level});
            });
        }
    }
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
    if (searchTerm) {
        allWords = allWords.filter(word => 
            word.en.toLowerCase().includes(searchTerm) || 
            word.ru.toLowerCase().includes(searchTerm)
        );
    }
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º—É —Å–ª–æ–≤—É
    allWords.sort((a, b) => a.en.localeCompare(b.en));
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    if (allWords.length === 0) {
        dictionaryList.innerHTML = `
            <div class="empty-message">
                <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 20px;"></i>
                <p>–°–ª–æ–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    allWords.forEach(word => {
        const isLearned = appState.stats.wordsLearned.has(word.en);
        const learnedClass = isLearned ? 'learned' : '';
        
        html += `
            <div class="word-card ${learnedClass}">
                <div class="word-header">
                    <div class="word-en">${word.en}</div>
                    <span class="word-level ${word.level}">${word.level}</span>
                </div>
                <div class="word-ru">${word.ru}</div>
                <div class="word-example">${word.example}</div>
                ${isLearned ? '<div class="word-learned"><i class="fas fa-check-circle"></i> –ò–∑—É—á–µ–Ω–æ</div>' : ''}
            </div>
        `;
    });
    
    dictionaryList.innerHTML = html;
}

function searchWords() {
    displayDictionary();
}

function filterDictionary() {
    displayDictionary();
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞
function addNewWord() {
    const enWord = document.getElementById('new-en-word').value.trim();
    const ruWord = document.getElementById('new-ru-word').value.trim();
    const example = document.getElementById('new-example').value.trim();
    const level = document.getElementById('new-level').value;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–æ–¥–∞
    if (!enWord || !ruWord) {
        showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!', 'error');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–µ —Å–ª–æ–≤–æ –Ω–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ
    if (appState.words[level]) {
        const existingWord = appState.words[level].find(w => w.en.toLowerCase() === enWord.toLowerCase());
        if (existingWord) {
            showNotification('–≠—Ç–æ —Å–ª–æ–≤–æ —É–∂–µ –µ—Å—Ç—å –≤ —Å–ª–æ–≤–∞—Ä–µ –Ω–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ!', 'warning');
            return;
        }
    } else {
        appState.words[level] = [];
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞
    const newWord = {
        en: enWord,
        ru: ruWord,
        example: example || `${enWord} - ${ruWord}`
    };
    
    appState.words[level].push(newWord);
    saveGameData();
    
    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById('new-en-word').value = '';
    document.getElementById('new-ru-word').value = '';
    document.getElementById('new-example').value = '';
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    updateWordCounts();
    updateUIStats();
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showNotification(`–°–ª–æ–≤–æ "${enWord}" –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —É—Ä–æ–≤–µ–Ω—å "${level}"!`, 'success');
    
    // –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    showMainMenu();
}

function updateWordCounts() {
    // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —É–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö, –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    updateUIStats();
}

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
function displayStats() {
    // –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    document.getElementById('stat-games').textContent = appState.stats.gamesPlayed;
    document.getElementById('stat-best').textContent = appState.stats.bestScore;
    document.getElementById('stat-learned').textContent = appState.stats.wordsLearned.size;
    
    // –¢–æ—á–Ω–æ—Å—Ç—å
    const accuracy = appState.stats.totalAnswers > 0 ? 
        Math.round((appState.stats.correctAnswers / appState.stats.totalAnswers) * 100) : 0;
    document.getElementById('stat-accuracy').textContent = `${accuracy}%`;
    
    // –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —É—Ä–æ–≤–Ω—è–º
    updateLevelProgress();
}

function updateLevelProgress() {
    const levels = ['beginner', 'intermediate', 'advanced'];
    
    levels.forEach(level => {
        const totalWords = appState.words[level] ? appState.words[level].length : 0;
        const learnedWords = totalWords > 0 ? 
            appState.words[level].filter(w => appState.stats.wordsLearned.has(w.en)).length : 0;
        const percentage = totalWords > 0 ? Math.round((learnedWords / totalWords) * 100) : 0;
        
        document.getElementById(`progress-${level}`).style.width = `${percentage}%`;
        document.getElementById(`progress-${level}-text`).textContent = `${percentage}%`;
    });
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏
function loadSettingsToUI() {
    document.getElementById('sound-toggle').checked = appState.settings.soundEnabled;
    document.getElementById('questions-count').value = appState.settings.questionsCount;
    document.getElementById('timer-setting').value = appState.settings.timerSeconds;
    document.getElementById('theme-select').value = appState.settings.theme;
}

function saveSettings() {
    appState.settings.soundEnabled = document.getElementById('sound-toggle').checked;
    appState.settings.questionsCount = parseInt(document.getElementById('questions-count').value);
    appState.settings.timerSeconds = parseInt(document.getElementById('timer-setting').value);
    appState.settings.theme = document.getElementById('theme-select').value;
    
    saveGameData();
    applySettings();
    
    showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
}

function applySettings() {
    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
    document.body.setAttribute('data-theme', appState.settings.theme);
    
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–º
    if (appState.settings.theme === 'dark') {
        document.documentElement.style.setProperty('--light-color', '#2c3e50');
        document.documentElement.style.setProperty('--dark-color', '#ecf0f1');
    } else {
        // –°–±—Ä–æ—Å –∫ —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º–µ
        document.documentElement.style.setProperty('--light-color', '#f8f9fa');
        document.documentElement.style.setProperty('--dark-color', '#343a40');
    }
}

function resetProgress() {
    showConfirmModal(
        '–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?',
        '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –∏–∑—É—á–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.',
        function() {
            appState.stats = {
                gamesPlayed: 0,
                bestScore: 0,
                wordsLearned: new Set(),
                totalAnswers: 0,
                correctAnswers: 0
            };
            
            saveGameData();
            displayStats();
            updateUIStats();
            
            showNotification('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω!', 'success');
        }
    );
}

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type} show`;
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
let currentConfirmCallback = null;

function showConfirmModal(title, message, callback) {
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-message').textContent = message;
    currentConfirmCallback = callback;
    
    document.getElementById('confirm-modal').classList.add('active');
}

function closeModal() {
    document.getElementById('confirm-modal').classList.remove('active');
    currentConfirmCallback = null;
}

function confirmAction() {
    if (currentConfirmCallback) {
        currentConfirmCallback();
    }
    closeModal();
}

// –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
function playSound(type) {
    if (!appState.settings.soundEnabled) return;
    
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º Web Audio API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Å—Ç—ã—Ö –∑–≤—É–∫–æ–≤
    
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        if (type === 'correct') {
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
            oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } else if (type === 'incorrect') {
            oscillator.frequency.setValueAtTime(220, audioContext.currentTime); // A3
            oscillator.frequency.setValueAtTime(196, audioContext.currentTime + 0.1); // G3
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }
    } catch (e) {
        console.log('Audio not supported:', e);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
function initEventListeners() {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && sections.game.classList.contains('active')) {
            checkAnswer();
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('confirm-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–ª–æ–≤
function updateWordCounts() {
    // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–∞–∫ updateUIStats()
    updateUIStats();
}